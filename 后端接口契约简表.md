# 后端接口契约简表（配合 BMT Central SDK）

本文档面向后端实现者，给出与 SDK 对接所需的最小但完整的 HTTP/Realtime 契约。含请求/响应 schema、状态码与错误模型、限流/熔断协作、示例及实现建议。

## 0. 总览与环境变量
- 前端环境变量
  - `VITE_API_BASE_URL`：业务 API 基础地址
  - `VITE_TELEMETRY_ENDPOINT`：遥测/性能上报入口（可统一一个 ingest）
  - `VITE_REALTIME_URL`：Socket.IO 服务器地址（可延后实现）
- SDK 模块 → 后端能力映射
  - `@platform/sdk-http` → 业务 API（Auth 刷新端点可选）
  - `@platform/sdk-telemetry` → 遥测/性能 Ingest
  - `@platform/sdk-realtime` → Socket.IO 服务（后续实现）

## 1. 公共协议与网关规范
- 统一请求头（建议）
  - `Content-Type: application/json`
  - `Accept: application/json`
  - `Authorization: Bearer <token>`（如需鉴权）
  - `X-Request-Id: <uuid>`（跟踪 ID，由前端或网关生成）
  - `X-SDK-App: <app>`（如 admin）
  - `X-SDK-Release: <semver>`（如 1.2.3）
  - `X-SDK-Version: <sdk_version>`（sdk 版本串，可选）
- 统一响应头（建议）
  - `X-RateLimit-Limit / Remaining / Reset`
  - `Retry-After`（429/503 时）
  - `Cache-Control`（遥测接口禁缓存：`no-store`）
- CORS（建议）
  - `Access-Control-Allow-Origin: <frontend-domain>` 或 `*`（遥测可放宽）
  - `Access-Control-Allow-Headers: Content-Type, Authorization, X-Request-Id, X-SDK-*`
  - 允许 `POST`、`OPTIONS`。
- 时间语义：所有时间戳使用 Unix ms（与 SDK 对齐）。

### 1.1 错误模型（与 sdk-http 错误约定对齐）
- HTTP 状态码：
  - 2xx：成功
  - 400：参数错误/格式错误（映射 Validation）
  - 401：未授权，触发前端 Token 过期处理
  - 403：权限不足
  - 404：未找到
  - 408 / 504：超时（映射 Timeout）
  - 429：限流（配合 `Retry-After`）
  - 5xx：服务错误（映射 Http）
  - 503：服务不可用（协作熔断，前端会进入短期开路）
- 错误响应 envelope（建议）
```json
{
  "code": "InvalidArgument | Unauthorized | RateLimited | Internal | ServiceUnavailable",
  "message": "人类可读错误",
  "details": { "field": "error detail ..." },
  "requestId": "..."
}
```

## 2. 遥测/性能 Ingest（Telemetry）
- 目的：接收 SDK 批量上报的页面/事件/错误/API/性能指标。
- 入口（推荐统一）：
  - `POST /v1/telemetry/ingest`
  - `Content-Type: application/json`（sendBeacon 可能使用 `text/plain`，后端需兼容）
  - Body：事件数组（批量）
- 事件通用 schema（与 SDK 一致）
```json
{
  "type": "page | event | error | api | perf",
  "name": "string",
  "ts": 1718000000000,
  "app": "admin",
  "release": "1.0.0",
  "user": { "id": "u_1", "role": "admin" },
  "props": { "k": "v" },
  "id": "evt_xxx",
  "sessionId": "sess_xxx"
}
```
- 请求示例（批量）
```bash
curl -X POST "$BASE/v1/telemetry/ingest" \
  -H 'content-type: application/json' \
  -d '[
    {"type":"page","name":"home","ts":1718000000000,"app":"admin","release":"1.0.0","props":{"url":"/"}},
    {"type":"api","name":"/api/orders","ts":1718000001200,"app":"admin","release":"1.0.0","props":{"status":200,"duration":120}}
  ]'
```
- 响应（建议）
```json
{ "accepted": 2, "rejected": 0, "requestId": "..." }
```
- 限制与状态码
  - 单次最大事件数：建议 ≤ 200，超出返回 413（Payload Too Large）
  - schema 校验失败：400 + 错误字段路径
  - 过载：429（带 `Retry-After` 秒级时间）或 503（配合前端熔断）
- 安全
  - 拒绝 Cookie；不依赖会话；仅用 Bearer（如需要鉴权）
  - 可按 app/release/user 维度分区与限速

### 2.1 性能专用入口（可选）
如需拆分：`POST /v1/telemetry/perf`，Body 仍是事件数组，但只接受 `type=perf`。其余同上。

## 3. 鉴权刷新端点（可选，供 sdk-http 的 Auth 插件）
- 用途：401 时刷新 AccessToken（前端单航刷新 single-flight）。
- 入口：`POST /v1/auth/refresh`
- 请求（示例）
```json
{ "refreshToken": "rt_abc", "fingerprint": "fp_xyz" }
```
- 响应
```json
{ "accessToken": "at_abc", "expiresIn": 3600 }
```
- 状态码
  - 200：成功，前端重放原请求
  - 401：刷新令牌无效，前端登出
  - 429/503：限流/过载

## 4. 实时服务（Realtime）— 预留（后续实现）
- 传输：Socket.IO（WebSocket 优先）
- 命名空间：`/rt`
- 握手：
  - `query.token=Bearer <token>` 或 `auth: { token }`
- 事件：
  - `subscribe` → `{ topic: string }` → `ack`
  - `publish` → `{ topic: string, id: string, seq?: number, payload: any }` → `ack`
  - 服务端 `event` → `{ topic, id, seq, payload, ts }`
  - `error` → `{ code, message }`
- 可靠性：
  - ack 超时与重发：由客户端控制，后端需去重（幂等 key: `topic+id`）
  - 序列：服务端为每 topic 维护 seq，自增；乱序/重放按 seq 处理
  - 限流：每连接/每 topic 消息速率限制；超限发送 `error: RateLimited`

## 5. HTTP 限流/熔断协作
- 限流：当后端判断需降载时返回 `429 Too Many Requests`，并带头 `Retry-After: <seconds>`；前端将退避重试。
- 熔断：当后端明确服务不可用时，返回 `503 Service Unavailable`，前端熔断器将进入开路，短期直接失败，间隔后半开探测。可附：
```json
{ "code": "ServiceUnavailable", "message": "maintenance", "retryAfter": 30 }
```
- 超时：务必在网关或服务端设置合理超时时间（如 10s），使前端能区分 Timeout。

## 6. 监控与可观测性建议
- Ingest 写入：分批批量写入 OLAP/TSDB（如 ClickHouse/BigQuery/TimescaleDB）
- 去重：`id` 或 `(app, ts, name, user.id)` 维度去重
- 审计：保留 `requestId` 与入口时间，便于追踪
- 数据保留：原始 7~30 天，聚合 90~180 天

## 7. 示例：最小实现草图（伪代码）
```ts
// express-like
app.post('/v1/telemetry/ingest', async (req, res) => {
  const events = parseJsonArray(req.body)
  if (!Array.isArray(events) || events.length === 0) return res.status(400).json({ code: 'InvalidArgument' })
  if (events.length > 200) return res.status(413).end()
  // validate schema fields ...
  await storage.batchInsert(events)
  res.setHeader('Cache-Control', 'no-store')
  res.status(200).json({ accepted: events.length, rejected: 0, requestId: req.headers['x-request-id'] })
})

app.post('/v1/auth/refresh', async (req, res) => {
  const { refreshToken } = req.body ?? {}
  if (!refreshToken) return res.status(400).json({ code: 'InvalidArgument' })
  const session = await auth.verify(refreshToken)
  if (!session) return res.status(401).json({ code: 'Unauthorized' })
  const accessToken = await auth.issueAccessToken(session.userId)
  res.json({ accessToken, expiresIn: 3600 })
})
```

---

附录：字段与约束清单（关键）
- Telemetry Event
  - `type`：枚举 `page|event|error|api|perf`
  - `name`：string（路由名/事件名/API 路径/指标名）
  - `ts`：number（ms）
  - `app`：string
  - `release`：semver
  - `user.id`：string|number 可选
  - `props`：对象，值允许基本类型/对象/数组；建议服务端做映射与限长
- 限长建议
  - `name` ≤ 200 chars
  - `props` JSON 序列化后 ≤ 10 KB
  - 单次上报条数 ≤ 200

> 如需扩展，请优先更新本表与 SDK 契约，保持前后端一致。