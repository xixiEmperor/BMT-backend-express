# BMT Platform SDK 后端接口需求文档

## 概述

本文档详细列出了 BMT Platform SDK 所需的所有后端接口，包括 HTTP API 和 WebSocket 服务。请根据此文档实现相应的后端服务。

---

## 1. 遥测数据上报服务（Telemetry API）

### 1.1 事件上报接口

**基本信息**
- **用途**: 接收前端上报的遥测事件数据（页面浏览、自定义事件、错误事件、性能数据等）
- **协议**: HTTP/HTTPS
- **方法**: POST
- **路径**: `/api/telemetry/events` （可自定义）

**请求格式**
```typescript
// Content-Type: application/json
interface TelemetryEvent {
  // 基础字段
  id: string               // 事件唯一ID
  type: 'page' | 'custom' | 'error' | 'api' | 'perf'  // 事件类型
  name: string             // 事件名称
  ts: number               // 时间戳（毫秒）
  
  // 应用信息
  app: string              // 应用名称
  release: string          // 版本号
  sessionId: string        // 会话ID
  
  // 用户信息（可选）
  user?: {
    id: string
    email?: string
    name?: string
    attrs?: Record<string, any>
  }
  
  // 事件属性
  props?: Record<string, any>
}

// 批量上报格式
type TelemetryBatch = TelemetryEvent[]
```

**请求示例**
```json
[
  {
    "id": "evt_abc123",
    "type": "page",
    "name": "/dashboard",
    "ts": 1703123456789,
    "app": "my-app",
    "release": "1.0.0",
    "sessionId": "sess_xyz789",
    "user": {
      "id": "user_123",
      "email": "user@example.com"
    },
    "props": {
      "url": "https://app.example.com/dashboard",
      "title": "Dashboard",
      "referrer": "https://app.example.com/login"
    }
  },
  {
    "id": "evt_def456",
    "type": "custom",
    "name": "button_click",
    "ts": 1703123460000,
    "app": "my-app",
    "release": "1.0.0",
    "sessionId": "sess_xyz789",
    "props": {
      "button_id": "save-btn",
      "section": "settings"
    }
  }
]
```

**响应格式**
```typescript
// 成功响应 (200 OK)
{
  "success": true,
  "received": number,     // 接收到的事件数量
  "processed": number,    // 成功处理的事件数量
  "errors"?: string[]     // 处理错误信息（如有）
}

// 错误响应 (400/500)
{
  "success": false,
  "error": string,
  "details"?: any
}
```

**关键要求**
1. **支持批量上报**: 单次请求可包含多个事件（建议支持 1-100 个事件）
2. **幂等性**: 相同 ID 的事件应该能够重复提交而不产生重复数据
3. **快速响应**: 响应时间应控制在 200ms 以内
4. **支持 Beacon**: 需要支持 `navigator.sendBeacon()` 发送的请求
5. **CORS 支持**: 允许跨域请求
6. **压缩支持**: 支持 gzip 压缩

### 1.2 事件类型详解

#### 页面浏览事件 (page)
```typescript
{
  "type": "page",
  "name": "/path/to/page",  // 页面路径
  "props": {
    "url": "完整URL",
    "title": "页面标题",
    "referrer": "来源页面",
    "query": {},           // URL查询参数
    "hash": "页面锚点"
  }
}
```

#### 自定义事件 (custom)
```typescript
{
  "type": "custom",
  "name": "事件名称",
  "props": {
    // 自定义属性
    [key: string]: any
  }
}
```

#### 错误事件 (error)
```typescript
{
  "type": "error",
  "name": "错误名称",
  "props": {
    "message": "错误消息",
    "stack": "错误堆栈",
    "filename": "文件名",
    "lineno": "行号",
    "colno": "列号",
    "severity": "error" | "warning" | "info",
    "context": "错误上下文"
  }
}
```

#### API调用事件 (api)
```typescript
{
  "type": "api",
  "name": "API路径",
  "props": {
    "method": "HTTP方法",
    "url": "请求URL",
    "status": "HTTP状态码",
    "duration": "请求耗时(ms)",
    "success": boolean
  }
}
```

#### 性能事件 (perf)
```typescript
{
  "type": "perf",
  "name": "性能指标名称",  // 如: LCP, FID, CLS
  "props": {
    "value": number,      // 指标值
    "rating": "good" | "needs-improvement" | "poor",
    "entryType": "指标类型"
  }
}
```

---

## 2. 用户认证服务（Authentication API）

### 2.1 Token 获取接口

**基本信息**
- **用途**: 为 WebSocket 连接和 API 调用提供认证 Token
- **协议**: HTTP/HTTPS
- **方法**: POST
- **路径**: `/api/auth/token`

**请求格式**
```typescript
{
  "grant_type": "client_credentials" | "password" | "refresh_token",
  "client_id": string,
  "client_secret"?: string,
  "username"?: string,
  "password"?: string,
  "refresh_token"?: string,
  "scope"?: string[]
}
```

**响应格式**
```typescript
{
  "access_token": string,
  "token_type": "Bearer",
  "expires_in": number,     // 过期时间（秒）
  "refresh_token"?: string,
  "scope": string[]
}
```

### 2.2 Token 刷新接口

**基本信息**
- **用途**: 刷新过期的访问令牌
- **协议**: HTTP/HTTPS
- **方法**: POST
- **路径**: `/api/auth/refresh`

**请求格式**
```typescript
{
  "refresh_token": string
}
```

**响应格式**
```typescript
{
  "access_token": string,
  "token_type": "Bearer",
  "expires_in": number,
  "refresh_token"?: string
}
```

### 2.3 Token 验证接口

**基本信息**
- **用途**: 验证 Token 有效性（用于 WebSocket 认证）
- **协议**: HTTP/HTTPS
- **方法**: GET
- **路径**: `/api/auth/verify`
- **认证**: Bearer Token

**响应格式**
```typescript
{
  "valid": boolean,
  "user": {
    "id": string,
    "email"?: string,
    "name"?: string,
    "permissions": string[]
  },
  "expires_at": number
}
```

---

## 3. 实时通信服务（WebSocket）

### 3.1 Socket.IO 服务器

**基本信息**
- **用途**: 提供实时双向通信能力
- **协议**: WebSocket (Socket.IO v4+)
- **端口**: 建议使用独立端口（如 3001）或与 HTTP 服务共用端口

**连接认证**
```typescript
// 客户端连接时发送的认证信息
{
  auth: {
    token: "Bearer <access_token>"
  }
}
```

### 3.2 支持的事件类型

#### 3.2.1 客户端到服务器事件

**订阅频道 (subscribe)**
```typescript
// 事件名: 'subscribe'
{
  "topic": string,        // 频道名称
  "messageId": string,    // 消息ID（用于ACK）
  "timestamp": number
}
```

**发布消息 (publish)**
```typescript
// 事件名: 'publish'
{
  "topic": string,        // 目标频道
  "payload": any,         // 消息内容
  "messageId": string,    // 消息ID
  "timestamp": number,
  "ackRequired": boolean  // 是否需要ACK确认
}
```

**心跳 (heartbeat)**
```typescript
// 事件名: 'heartbeat'
{
  "timestamp": number
}
```

#### 3.2.2 服务器到客户端事件

**消息分发 (message)**
```typescript
// 事件名: 'message'
{
  "id": string,
  "topic": string,
  "type": "event",
  "payload": any,
  "timestamp": number,
  "from"?: string         // 发送者ID
}
```

**ACK确认 (ack)**
```typescript
// 事件名: 'ack'
{
  "id": string,           // 对应的消息ID
  "type": "ack",
  "status": "success" | "error",
  "error"?: string
}
```

**系统通知 (notification)**
```typescript
// 事件名: 'notification'
{
  "id": string,
  "type": "notification",
  "level": "info" | "warning" | "error",
  "message": string,
  "timestamp": number
}
```

### 3.3 频道管理

**支持的频道类型**
- **公共频道**: 所有用户都可以订阅/发布
- **私有频道**: 需要特定权限才能访问
- **用户频道**: 用户个人专属频道（如 `user:${userId}`）

**频道命名规范**
- 公共频道: `public:channel-name`
- 私有频道: `private:channel-name`
- 用户频道: `user:${userId}`
- 系统频道: `system:notifications`

### 3.4 连接管理

**连接生命周期**
1. **握手**: 客户端发起连接请求，携带认证信息
2. **认证**: 服务器验证 Token 有效性
3. **连接建立**: 认证成功后建立 WebSocket 连接
4. **心跳保活**: 客户端定期发送心跳包（30秒间隔）
5. **自动重连**: 连接断开时客户端自动重连

**错误处理**
- 认证失败: 返回 `auth_error` 事件
- 权限不足: 返回 `permission_denied` 事件
- 频道不存在: 返回 `channel_not_found` 事件
- 消息格式错误: 返回 `invalid_message` 事件

---

## 4. 配置和管理接口

### 4.1 SDK 配置接口

**基本信息**
- **用途**: 提供动态 SDK 配置（采样率、功能开关等）
- **协议**: HTTP/HTTPS
- **方法**: GET
- **路径**: `/api/sdk/config`

**响应格式**
```typescript
{
  "telemetry": {
    "enabled": boolean,
    "endpoint": string,
    "sampleRate": number,
    "batchSize": number,
    "flushInterval": number
  },
  "performance": {
    "enabled": boolean,
    "sampleRate": number,
    "webVitals": boolean
  },
  "realtime": {
    "enabled": boolean,
    "url": string,
    "heartbeatInterval": number
  },
  "features": {
    [featureName: string]: boolean
  }
}
```

### 4.2 健康检查接口

**基本信息**
- **用途**: 检查各个服务的健康状态
- **协议**: HTTP/HTTPS
- **方法**: GET
- **路径**: `/api/health`

**响应格式**
```typescript
{
  "status": "healthy" | "degraded" | "unhealthy",
  "services": {
    "telemetry": "healthy" | "unhealthy",
    "auth": "healthy" | "unhealthy",
    "websocket": "healthy" | "unhealthy",
    "database": "healthy" | "unhealthy"
  },
  "timestamp": number
}
```

---

## 5. 部署和环境要求

### 5.1 基础设施要求

**服务器规格**
- **CPU**: 2 核心以上
- **内存**: 4GB 以上
- **存储**: SSD 建议，50GB 以上
- **网络**: 支持 WebSocket，带宽 100Mbps 以上

**技术栈建议**
- **Node.js**: v18+ (使用 Socket.IO)
- **Python**: v3.9+ (使用 Flask/FastAPI + socketio)
- **Go**: v1.19+ (使用 Gin + socketio)
- **Java**: v11+ (使用 Spring Boot + socketio)

### 5.2 安全要求

**HTTPS/WSS**
- 生产环境必须使用 HTTPS 和 WSS
- 支持 TLS 1.2 以上

**CORS 配置**
```typescript
{
  "origin": ["https://yourdomain.com", "https://app.yourdomain.com"],
  "methods": ["GET", "POST", "OPTIONS"],
  "allowedHeaders": ["Content-Type", "Authorization"],
  "credentials": true
}
```

**速率限制**
- 遥测接口: 1000 请求/分钟/IP
- 认证接口: 60 请求/分钟/IP
- WebSocket 连接: 100 连接/分钟/IP

### 5.3 监控指标

**关键指标**
- 请求延迟 (P95 < 200ms)
- 错误率 (< 1%)
- WebSocket 连接数
- 消息吞吐量
- 存储使用率

**日志记录**
- 所有 API 请求/响应
- WebSocket 连接/断开事件
- 错误和异常信息
- 性能指标

---

## 6. 示例实现参考

### 6.1 Node.js + Express + Socket.IO

```typescript
// 遥测接口示例
app.post('/api/telemetry/events', async (req, res) => {
  try {
    const events = req.body as TelemetryEvent[]
    
    // 验证数据格式
    const validEvents = events.filter(validateEvent)
    
    // 批量存储
    await telemetryService.saveEvents(validEvents)
    
    res.json({
      success: true,
      received: events.length,
      processed: validEvents.length
    })
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    })
  }
})

// WebSocket 认证示例
io.use(async (socket, next) => {
  try {
    const token = socket.handshake.auth.token
    const user = await authService.verifyToken(token)
    socket.user = user
    next()
  } catch (error) {
    next(new Error('Authentication failed'))
  }
})

// 消息处理示例
io.on('connection', (socket) => {
  socket.on('subscribe', async (data) => {
    const { topic, messageId } = data
    
    // 检查权限
    if (await hasPermission(socket.user, topic)) {
      socket.join(topic)
      socket.emit('ack', { id: messageId, status: 'success' })
    } else {
      socket.emit('ack', { id: messageId, status: 'error', error: 'Permission denied' })
    }
  })
  
  socket.on('publish', async (data) => {
    const { topic, payload, messageId } = data
    
    // 分发消息到订阅者
    socket.to(topic).emit('message', {
      id: generateId(),
      topic,
      type: 'event',
      payload,
      timestamp: Date.now(),
      from: socket.user.id
    })
    
    socket.emit('ack', { id: messageId, status: 'success' })
  })
})
```

---

## 7. 测试建议

### 7.1 接口测试

**遥测接口测试**
```bash
# 单个事件测试
curl -X POST http://localhost:3000/api/telemetry/events \
  -H "Content-Type: application/json" \
  -d '[{"id":"test1","type":"custom","name":"test","ts":1703123456789,"app":"test","release":"1.0.0","sessionId":"sess1"}]'

# 批量事件测试
curl -X POST http://localhost:3000/api/telemetry/events \
  -H "Content-Type: application/json" \
  -d @batch_events.json
```

**WebSocket 测试**
使用 Socket.IO 客户端测试连接、订阅、发布等功能。

### 7.2 性能测试

- 使用 Apache Bench 或 wrk 进行压力测试
- 模拟高并发 WebSocket 连接
- 测试大批量数据上报的性能

---

## 总结

以上文档详细描述了 BMT Platform SDK 所需的所有后端接口。关键要点：

1. **遥测服务**: 高性能、支持批量、幂等性
2. **认证服务**: JWT Token 管理，支持刷新
3. **实时通信**: Socket.IO v4，支持频道订阅/发布
4. **安全性**: HTTPS/WSS、CORS、速率限制
5. **可扩展性**: 支持水平扩展和负载均衡

建议按照此文档实现后端服务，确保与前端 SDK 的完美集成。